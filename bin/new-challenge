#!/bin/bash

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
BASE_DIR="$(dirname "$SCRIPT_DIR")"
TEMPLATE_DIR="$BASE_DIR/misc/ts-starter"

CATEGORIES=("arrays-and-hashing" "matrix" "linked-list" "graph" "strings" "stack" "misc")

show_usage() {
    echo "Usage: new-challenge <category> <name>"
    echo ""
    echo "Categories:"
    for cat in "${CATEGORIES[@]}"; do
        echo "  - $cat"
    done
    exit 1
}

if [ -z "$1" ] || [ -z "$2" ]; then
    show_usage
fi

CATEGORY="$1"
PROJECT_NAME="$2"

# Validate category
VALID_CATEGORY=false
for cat in "${CATEGORIES[@]}"; do
    if [ "$cat" == "$CATEGORY" ]; then
        VALID_CATEGORY=true
        break
    fi
done

if [ "$VALID_CATEGORY" == false ]; then
    echo "Error: Invalid category '$CATEGORY'"
    echo ""
    show_usage
fi

CATEGORY_DIR="$BASE_DIR/$CATEGORY"
PROJECT_DIR="$CATEGORY_DIR/$PROJECT_NAME"

if [ ! -d "$CATEGORY_DIR" ]; then
    echo "Error: Category directory '$CATEGORY' not found"
    exit 1
fi

if [ -d "$PROJECT_DIR" ]; then
    echo "Error: Directory '$PROJECT_NAME' already exists in $CATEGORY"
    exit 1
fi

if [ ! -d "$TEMPLATE_DIR" ]; then
    echo "Error: Template directory 'misc/ts-starter' not found"
    exit 1
fi

echo "Creating new challenge: $CATEGORY/$PROJECT_NAME"

cp -r "$TEMPLATE_DIR" "$PROJECT_DIR"

echo "Installing dependencies..."
cd "$PROJECT_DIR"
npm install

echo "Opening in VS Code..."
code "$PROJECT_DIR"

echo "Done! Happy coding!"
